// This is your Prisma schema file
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  admin
  author
  viewer
}

model User {
  id              Int               @id @default(autoincrement())
  username        String            @unique
  email           String            @unique
  passwordHash    String            @map("password_hash")
  role            Role              @default(viewer)
  stories         Story[]           @relation("AuthorStories")
  readingProgress ReadingProgress[]
  createdAt       DateTime          @default(now()) @map("created_at")

  @@map("users")
}

model Story {
  id             Int               @id @default(autoincrement())
  title          String
  description    String?           @db.Text
  posterFilename String?           @map("poster_filename")
  status         String            @default("ongoing")
  viewCount      Int               @default(0) @map("view_count")
  authorId       Int?              @map("author_id")
  author         User?             @relation("AuthorStories", fields: [authorId], references: [id])
  chapters       Chapter[]
  progress       ReadingProgress[]
  createdAt      DateTime          @default(now()) @map("created_at")

  @@map("stories")
}

model Chapter {
  id        Int      @id @default(autoincrement())
  storyId   Int      @map("story_id")
  orderNum  Int      @map("order_num")
  title     String
  content   String   @db.LongText
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([storyId, orderNum])
  @@map("chapters")
}

model ReadingProgress {
  userId        Int      @map("user_id")
  storyId       Int      @map("story_id")
  lastChapterId Int      @map("last_chapter_id")
  updatedAt     DateTime @updatedAt @map("updated_at")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  story         Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@id([userId, storyId])
  @@map("reading_progress")
}